---
title: 基于多步视差的深度估计
data:  2025-10-17 
tags:
    - 三维视觉
    - 深度估计
    - 学习笔记
---
本文章的方法源于论文《Accurate Multiple View 3D Reconstruction Using Patch-Based Stereo for Large-Scale Scenes》

## 基础方法介绍

在整体的针对基于多步视差获取深度估计的算法中，完整算法步骤分为如下四步：

1. 立体像对选择 （Stereo Pair Selection）
2. 深度图计算 （Depth-Map Computation）
3. 深度图优化 （Depth-Map Refinement）
4. 深度图融合 （Depth-Map Merging）

其是一个用于单目相机连续或相关帧之间的深度估计算法，实际上正好符合对于SLAM定位技术中的基本需求。

## 立体像对选择 （Stereo Pair Selection）

`立体像对的选取`不仅关系到立体匹配的精度，还将直接影响最终多视图三维重建MVS（区别与SFM，为稠密建图）的效果。在实际的方法测试中，立体像的选取对于街景这种高结构化场景非常简单，但是对于其他普遍性的无序场景，需要额外的设计。理想的参考图需要满足两个条件：

1. 与目标图像的拍摄视角合适（视角适中）
2. 具有适中的基线距离
   - 过短会导致三位重建精度下降
   - 过长则可能造成场景共同覆盖区域不足

事实上，该选择方法可以直接参考SFM中的图像对选取，通过计算两图像图像共视点夹角之间的平均值或中位值进行判断，对于图像$i$，计算其与其他图像之间的夹角$\theta_{i,j}$选取其中夹角在$5^\circ$至$60^\circ$之间的图像对。
对于满足夹角的图像，计算每对图像光学中心点之间的距离$d_{i,j}$，计算其中中位数$d$，剔除$d_{i,j}>2d$ 或 $d_{i,j}<0.05d$ 的异常图像。若剩余图像不足 $k_1$ 张（在该论文中设 $k_1$=10），则全部视为图像$i$的邻域图像集合N(i)；否则按 $\theta_{i,j} \dot d_{i,j}$ 升序排列，取前 $k_1$ 张作为 $N(i)$ 。最终从 $N(i)$ 中选取乘积最小的图像作为第 $i$ 张图像的参考图像，构成立体像对。

## 深度图计算 （Depth-Map Computation）

对于深度图计算的核心思想是：对于输入的每个像素点，尝试找到一个最佳的支撑平面，使其与参考图像之间的聚合匹配成本最小。支撑平面 $
f$ 的本质是场景表面的局部切平面，该平面由关联相机坐标系中的三维点 $x_i$ 及其法向量 $n_i$ 表示。

在图像集中的第 $i$ 张输入图像 $I_i$中，给定其参考图 $I_j$ 以及其对应的相机参数组合 $\{K_i, R_i, C_i\}$ 和 $\{K_j, R_j, C_j\}$，其中 $K$ 代表内参矩阵，$R$ 为旋转矩阵，$C$ 表示相机中心），我们首先为 $Ii$ 中的每个像素点 $p$ 随机分配一个三维平面。设像素点 $p$ 的齐次坐标为：

$$\mathbf{p} = \begin{bmatrix} u \\ v \\ 1 \end{bmatrix}$$

三维点 $X_i$ 必须位于点 $p$ 的观测射线上，我们在深度范围 $\lambda \in [\lambda_{min}, \lambda_{max}]$ 内随机选择一个深度 $\lambda$ ，然后在相机 $C_i$ 的坐标系中计算 $X_i$ ：
$$X_i = \lambda K_i^{-1} p$$
然后我们在相机$C_i$的球面坐标系中随机分配平面的法向量，如下所示：

$$\mathbf{n_i} = \begin{bmatrix} \cos\theta\sin\phi \newline 
                                 \sin\theta\sin\phi \newline  
                                 \cos\phi \end{bmatrix}$$

其中，$\theta$ 是范围 $[0°, 360°]$ 内的随机角度， $\phi$ 是范围 $[0°, 60°]$ 内的随机角度。通过球面坐标系获取的法向量方式分布更加均匀。这些范围设置基于一个简单假设：当图像块法向量 $n_i$ 与相机 $C_i$ 坐标系的z轴之间夹角低于某个阈值时，该图像块在图像 $I_i$ 中是可见的（论文中将此阈值设置为60°）。

这个分配的操作本质是给每个像素一个基础的猜测值，该操作也大概率能为图像中的每个场景平面保留至少一个有效猜测值。一旦完成了图像 $I_i$ 的深度图计算，在后期处理其参考图 $I_j$ 的深度图时就能改进其纯随机的初始化方法。此时，$I_i$ 深度图中各像素的深度值和面片法线可以通过视点变换映射到 $I_j$，作为计算 $I_j$ 深度图的初始估计值；而 $I_i$ 与 $I_j$ 之间不存在映射关系的 $I_j$ 像素点仍需保持随机初始化状态。通过这种方式，我们能为 $I_j$ 中每个经视点变换的像素赋予比随机猜测更优的初始平面，因为该平面在立体图像对 $I_i$ 和 $I_j$ 之间具有一致性。

接下来基于平面诱导单应矩阵的方法进行深度匹配估计

### 深度匹配估计

#### 1. 单应矩阵计算（关键操作）

- 输入：两个相机的内外参 $\{K_i, R_i, C_i\}$、$\{K_j, R_j, C_j\}$ 和一个平面参数 $f_p = \{X_i, \mathbf{n}_i\}$（定义在相机 $C_i$ 坐标系）。
- 操作：

  将世界坐标系对齐到相机 $C_i$，标准化投影矩阵：

  $$
     P_i = K_i[I \mid \mathbf{0}], \quad P_j = K_j[R_jR_i^{-1} \mid R_j(C_i - C_j)]
  $$

  计算平面诱导的单应矩阵 $H_{ij}$：

  $$
     H_{ij} = K_j \left( R_jR_i^{-1} + \frac{R_j(C_i - C_j)\mathbf{n}_i^\top}{\mathbf{n}_i^\top X_i} \right) K_i^{-1}
  $$

- 作用：通过单应将图像 $I_i$ 的像素映射到图像 $I_j$ 的对应位置。

#### 2. 归一化互相关（NCC）匹配代价聚合

- 输入：当前像素 $p$、单应矩阵 $H_{ij}$、局部窗口 $B$（如 $7 \times 7$ 邻域）。
- 操作：

  对窗口 $B$ 内每个像素 $q$，用 $H_{ij}$ 计算其在参考图像 $I_j$ 中的对应点 $H_{ij}(q)$。
计算 $q$ 和 $H_{ij}(q)$ 的 NCC 分数（比较信号差异性，即窗口 $B$ 中像素差异与在参考图上对应点间的差异）：



  $$
     \text{NCC} = \frac{\sum (q - \bar{q})(H_{ij}(q) - \overline{H_{ij}(q)})}{\sqrt{\sum (q - \bar{q})^2 \sum (H_{ij}(q) - \overline{H_{ij}(q)})^2}}
  $$

  聚合代价 $m(p, f_p) = 1 - \text{NCC}$（NCC 范围 $[-1, 1]$，代价越小匹配越好）。

- 作用：衡量当前像素 $p$ 与平面假设 $f_p$ 的光度一致性。

#### 3. 简化设计的理由

高分辨率图像：提供了足够可靠的匹配，NCC 简单高效。
后续优化：不可靠匹配会被深度图优化（如滤波、CRF）剔除，最终结果与复杂方法接近。

### 空间传播

通过解该最优化问题后，对于该图像通过正向和反向遍历图像中的各个像素来优化其对应的平面。
每次迭代中，每个像素会进行两种操作：空间传播与随机赋值。空间传播通过比对相邻像素平面与当前像素平面的匹配代价，若满足条件 $m(p, f_{pN}) < m(p, f_p)$ ，则将更优的邻域平面$f_{pN}$ 传播至当前像素 $p$（即令 $f_p$ = $f_pN$）。该操作依赖高分辨率图像中相邻像素共享相似3D平面的特性。理论上，仅需经过奇偶次空间传播：奇数轮次选取左、上、左上邻域，偶数轮次选取右、下、右下邻域，就能将优质平面猜测快速传播至整个区域。

### 随机赋值

在完成空间传递后，采用随机分配方法进一步优化平面参数 $f_p$。该方法的原理是通过随机测试多组平面参数，从而降低匹配代价。具体实现包含五个步骤：

1. 参数扰动
  随机生成新参数：

  $$
     \lambda' \in [\lambda - \Delta\lambda, \lambda + \Delta\lambda], \quad
     \theta' \in [\theta - \Delta\theta, \theta + \Delta\theta], \quad
     \phi' \in [\phi - \Delta\phi, \phi + \Delta\phi]
  $$

2. 更新平面
  计算新平面参数 $f'_p = \{X'_i, \mathbf{n}'_i\}$ 
3. 代价判断：若新代价更低（$m(p, f'_p) < m(p, f_p)$），则接受更新：

  $$
     (\lambda, \theta, \phi) \leftarrow (\lambda', \theta', \phi')
  $$

4. 缩小搜索范围
  将范围减半：

  $$
     \Delta\lambda \leftarrow \Delta\lambda/2, \quad
     \Delta\theta \leftarrow \Delta\theta/2, \quad
     \Delta\phi \leftarrow \Delta\phi/2
  $$

5. 迭代终止
  重复上述步骤 $k_3 = 6$ 次。

经过空间传播和随机分配处理后，我们会从深度图中剔除那些聚合匹配代价超过阈值 $τ_1$（本文设定$τ_1=0.3$）的不可靠点。


## 深度图优化 （Depth-Map Refinement）

由于原始深度图在公共区域可能因深度误差不一致，需通过优化过程加强相邻视图间的约束。具体步骤如下：

1. 3D反投影
  对图像 $I_i$ 中的每个点 $p$，根据深度 $\lambda$ 和相机参数将其反投影到3D空间：

  $$
     \mathbf{X} = \lambda R_i^\top K_i^{-1} p + C_i \tag{7}
  $$
  其中 $p$ 是齐次坐标（由式1定义），$\mathbf{X}$ 为世界坐标系下的3D点。

2. 邻视图投影
  将 $\mathbf{X}$ 投影到 $I_i$ 的相邻视图 $N(i)$（来自立体像对选择阶段）。对第 $k$ 个邻视图 $N_k$：
  真实深度：$d(\mathbf{X}, N_k)$（$\mathbf{X}$ 在相机 $N_k$ 中的深度）
  估计深度：$\lambda(\mathbf{X}, N_k)$（通过 $N_k$ 的深度图计算）

3. 一致性判定
  若满足深度一致性：
  $$
   \frac{|d(\mathbf{X}, N_k) - \lambda(\mathbf{X}, N_k)|}{\lambda(\mathbf{X}, N_k)} < \tau_2 \quad (\tau_2 = 0.01)
  $$
  则称 $\mathbf{X}$ 在 $I_i$ 和 $N_k$ 中一致。

4. 可靠性过滤
  当 $\mathbf{X}$ 在至少 $k_4 = 2$ 个邻视图中一致时，保留 $I_i$ 深度图中对应像素 $p$；否则剔除。

- 优化效果：该方法可去除多数误差，最终生成各视角下干净的深度图。

## 深度图融合 （Depth-Map Merging）

针对多视图中，存在视角重合，所以要进行深度图融合保证深度一致性。通过邻视图深度测试进一步去冗：

1. 冗余检测流程
   对相机 $C_i$ 深度图中的每个像素 $p$ 反投影为3D点 $\mathbf{X}$ ：
   $$
      \mathbf{X} = \lambda R_i^\top K_i^{-1} p + C_i
   $$
2. 深度比较规则
   - 遮挡情况：
     若邻视图中的真实深度 $d(\mathbf{X}, N_k)$ 小于其深度图的估计值 $\lambda(\mathbf{X}, N_k)$，判定为遮挡，剔除邻视图中的对应点。
   - 冗余情况（如邻视图 $N_4$）：
     若两者深度接近（$\frac{|d(\mathbf{X}, N_k) - \lambda(\mathbf{X}, N_k)|}{\lambda(\mathbf{X}, N_k)} < \tau$），判定为重复点，剔除邻视图中的对应点。

3. 生成点云
   - 合并所有深度图的3D反投影点，得到密集点云。
   - 稀疏化控制：
     若需降低点云密度，可仅保留深度图中稀疏位置（如 $(2n, 2n)$ 像素）的点，使点云规模降至$1/4$。

## 总结

老套的深度估计方法，但是平衡了速度与精度，相当经典的算法，推荐作为**CV**研究的前置学习内容。
